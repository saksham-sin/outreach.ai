$schema: https://railway.app/railway.schema.json

services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    port: 8000
    healthcheckPath: /health
    healthcheckTimeout: 10
    startCommand: |
      alembic upgrade head && uvicorn app.main:app --host 0.0.0.0 --port 8000
    variables:
      DATABASE_URL: ${{ DATABASE_URL }}
      SECRET_KEY: ${{ SECRET_KEY }}
      OPENAI_API_KEY: ${{ OPENAI_API_KEY }}
      EMAIL_PROVIDER: ${{ EMAIL_PROVIDER }}
      POSTMARK_SERVER_TOKEN: ${{ POSTMARK_SERVER_TOKEN }}
      POSTMARK_INBOUND_ADDRESS: ${{ POSTMARK_INBOUND_ADDRESS }}
      RESEND_API_KEY: ${{ RESEND_API_KEY }}
      RESEND_FROM_DOMAIN: ${{ RESEND_FROM_DOMAIN }}
      EMAIL_FROM_ADDRESS: ${{ EMAIL_FROM_ADDRESS }}
      EMAIL_FROM_NAME: ${{ EMAIL_FROM_NAME }}
      APP_BASE_URL: ${{ APP_BASE_URL }}
      FRONTEND_URL: ${{ FRONTEND_URL }}
      WEBHOOK_USERNAME: ${{ WEBHOOK_USERNAME }}
      WEBHOOK_PASSWORD: ${{ WEBHOOK_PASSWORD }}
      ACCESS_TOKEN_EXPIRE_DAYS: ${{ ACCESS_TOKEN_EXPIRE_DAYS }}
      MAGIC_LINK_EXPIRE_MINUTES: ${{ MAGIC_LINK_EXPIRE_MINUTES }}
      WORKER_POLL_INTERVAL_SECONDS: ${{ WORKER_POLL_INTERVAL_SECONDS }}
      MAX_RETRY_ATTEMPTS: ${{ MAX_RETRY_ATTEMPTS }}

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    port: 80
    healthcheckPath: /health
    healthcheckTimeout: 10
    variables:
      VITE_BACKEND_HOST: ${{ VITE_BACKEND_HOST }}

  postgres:
    image: postgres:15-alpine
    port: 5432
    variables:
      POSTGRES_PASSWORD: ${{ POSTGRES_PASSWORD }}
      POSTGRES_DB: ${{ POSTGRES_DB }}
      POSTGRES_USER: ${{ POSTGRES_USER }}
    volumes:
      - postgres_data:/var/lib/postgresql/data

volumes:
  postgres_data:
